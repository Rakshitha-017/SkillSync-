<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Recruiter Dashboard - SkillSync</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%); 
            min-height: 100vh; 
            color: #e0e0e8;
        }
        .header { 
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); 
            color: white; padding: 20px 0; 
        }
        .header-content { 
            max-width: 1200px; margin: 0 auto; padding: 0 20px; 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .logo h1 { font-size: 1.8em; }
        .user-info { display: flex; align-items: center; gap: 20px; }
        .logout-btn { 
            background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3); 
            color: white; padding: 10px 20px; border-radius: 25px; cursor: pointer; 
            transition: 0.3s;
        }
        .logout-btn:hover { 
            background: rgba(255,255,255,0.2); 
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 30px 20px; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .card { 
            background: rgba(20, 20, 40, 0.8); 
            padding: 30px; 
            border-radius: 20px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border: 1px solid rgba(220, 38, 38, 0.2);
            backdrop-filter: blur(10px);
        }
        .card h3 { margin-bottom: 20px; color: #e0e0e8; display: flex; align-items: center; gap: 10px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #e0e0e8; font-weight: 500; }
        .form-group input, .form-group textarea, .form-group select { 
            width: 100%; padding: 14px 16px; border: 2px solid rgba(220, 38, 38, 0.2); border-radius: 12px; 
            font-size: 14px; font-family: inherit;
            background: rgba(25, 25, 45, 0.8);
            color: #e0e0e8;
        }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { 
            border-color: #dc2626; outline: none;
            box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.2);
            background: rgba(30, 30, 50, 0.9);
        }
        .btn { 
            padding: 14px 28px; background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; border: none; 
            border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.3s; 
            font-size: 14px;
        }
        .btn:hover { 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        .btn.secondary { 
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); 
        }
        .btn.secondary:hover { 
            background: linear-gradient(135deg, #5a6268 0%, #495057 100%);
        }
        .filter-controls { 
            background: rgba(20, 20, 40, 0.8); 
            padding: 25px; 
            border-radius: 20px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            margin-bottom: 30px;
            border: 1px solid rgba(220, 38, 38, 0.2);
            backdrop-filter: blur(10px);
        }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .students-section { 
            background: rgba(20, 20, 40, 0.8); 
            padding: 25px; 
            border-radius: 20px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border: 1px solid rgba(220, 38, 38, 0.2);
            backdrop-filter: blur(10px);
        }
        .student-card { 
            padding: 20px; 
            border: 1px solid rgba(220, 38, 38, 0.2); 
            border-radius: 12px; 
            margin-bottom: 15px; 
            transition: 0.3s;
            background: rgba(25, 25, 45, 0.5);
        }
        .student-card:hover { 
            border-color: #dc2626; 
            background: rgba(220, 38, 38, 0.1);
        }
        .student-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; }
        .student-info h4 { color: #e0e0e8; margin-bottom: 5px; }
        .student-info p { color: #a0a0c8; font-size: 14px; }
        .scores { display: flex; gap: 15px; margin-top: 10px; }
        .score-badge { 
            padding: 8px 12px; border-radius: 20px; 
            font-size: 12px; font-weight: 600; 
        }
        .score-badge.high { background: linear-gradient(90deg, #dc2626, #ef4444); color: white; }
        .score-badge.medium { background: linear-gradient(90deg, #b91c1c, #dc2626); color: white; }
        .score-badge.low { background: linear-gradient(90deg, #ef4444, #f87171); color: white; }
        .welcome { 
            background: rgba(20, 20, 40, 0.8); 
            padding: 30px; 
            border-radius: 20px; 
            margin-bottom: 30px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border: 1px solid rgba(220, 38, 38, 0.2);
            backdrop-filter: blur(10px);
        }
        .stats { display: flex; gap: 20px; margin-top: 20px; }
        .stat-item { text-align: center; flex: 1; }
        .stat-number { font-size: 1.5em; font-weight: bold; color: #dc2626; }
        .loading { text-align: center; padding: 40px; color: #a0a0c8; }
        .empty-state { text-align: center; padding: 40px; color: #dc2626; }
        .requirements-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .job-list { margin-top: 20px; }
        .job-item { 
            padding: 15px; 
            border: 1px solid rgba(220, 38, 38, 0.2); 
            border-radius: 12px; 
            margin-bottom: 10px; 
            background: rgba(25, 25, 45, 0.5);
            transition: 0.3s;
        }
        .job-item:hover {
            border-color: #dc2626;
            background: rgba(220, 38, 38, 0.1);
            transform: translateY(-1px);
        }
        .job-item h5 { color: #e0e0e8; margin-bottom: 5px; }
        .job-item p { font-size: 13px; color: #a0a0c8; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <h1>üëî Recruiter Dashboard</h1>
            </div>
            <div class="user-info">
                <span id="userName">Loading...</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="welcome">
            <h2>Hey there, <span id="userDisplayName">recruiter</span>! üéØ</h2>
            <p>Ready to discover some amazing talent? Let's find your next rockstar hire! üåü</p>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="totalJobs">0</div>
                    <div>Active Jobs</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="totalStudents">0</div>
                    <div>Available Candidates</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="matchingCandidates">0</div>
                    <div>Matching Profiles</div>
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <!-- Job Posting Form -->
            <div class="card">
                <h3>üìù Post Your Dream Job</h3>
                <form id="jobForm">
                    <div class="form-group">
                        <label for="jobTitle">Job Title:</label>
                        <input type="text" id="jobTitle" required placeholder="e.g., Software Developer">
                    </div>
                    
                    <div class="form-group">
                        <label for="company">Company:</label>
                        <input type="text" id="company" required placeholder="e.g., Tech Innovations Inc.">
                    </div>
                    
                    <div class="form-group">
                        <label for="description">Job Description:</label>
                        <textarea id="description" required placeholder="Describe the role, responsibilities, and what you're looking for..."></textarea>
                    </div>
                    
                    <h4 style="margin: 20px 0 15px 0; color: #333;">Minimum Skill Requirements:</h4>
                    <div class="requirements-grid">
                        <div class="form-group">
                            <label for="aptitudeReq">Aptitude (0-100):</label>
                            <input type="number" id="aptitudeReq" min="0" max="100" value="50">
                        </div>
                        <div class="form-group">
                            <label for="technicalReq">Technical (0-100):</label>
                            <input type="number" id="technicalReq" min="0" max="100" value="50">
                        </div>
                        <div class="form-group">
                            <label for="communicationReq">Communication (0-100):</label>
                            <input type="number" id="communicationReq" min="0" max="100" value="50">
                        </div>
                    </div>
                    
                    <button type="submit" class="btn">Post Job</button>
                </form>
            </div>

            <!-- Posted Jobs -->
            <div class="card">
                <h3>üíº Your Posted Jobs</h3>
                <div id="postedJobs">
                    <div class="loading">Loading your job postings...</div>
                </div>
            </div>
        </div>

        <!-- Student Filter -->
        <div class="filter-controls">
                <h3>üîç Find Your Next Superstar</h3>
            <p style="margin-bottom: 20px; color: #666;">Filter candidates by minimum skill requirements</p>
            
            <div class="filter-grid">
                <div class="form-group">
                    <label for="filterAptitude">Min Aptitude:</label>
                    <input type="number" id="filterAptitude" min="0" max="100" value="0">
                </div>
                <div class="form-group">
                    <label for="filterTechnical">Min Technical:</label>
                    <input type="number" id="filterTechnical" min="0" max="100" value="0">
                </div>
                <div class="form-group">
                    <label for="filterCommunication">Min Communication:</label>
                    <input type="number" id="filterCommunication" min="0" max="100" value="0">
                </div>
                <div class="form-group" style="display: flex; align-items: end;">
                    <button class="btn" onclick="filterStudents()">Search Candidates</button>
                </div>
            </div>
        </div>

        <!-- Students List -->
        <div class="students-section">
            <h3>üë• Matching Candidates</h3>
            <div id="studentsList">
                <div class="empty-state">
                    <p>Use the filter above to find candidates matching your requirements</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let userProfile = null;
        let postedJobs = [];

        async function loadProfile() {
            try {
                const response = await fetch('/api/profile');
                const data = await response.json();
                
                if (data.id && data.role === 'recruiter') {
                    userProfile = data;
                    document.getElementById('userName').textContent = data.name;
                    loadPostedJobs();
                    loadAllStudents();
                } else {
                            // In dev, try a demo login so recruiters can view the page without creating an account
                            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                                tryDemoLogin();
                            } else {
                                window.location.href = '/login.html';
                            }
                        }
            } catch (error) {
                console.error('Error loading profile:', error);
                    // Try demo login in local dev
                    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') tryDemoLogin();
                    else window.location.href = '/login.html';
            }
        }

        async function tryDemoLogin(){
            try {
                const resp = await fetch('/api/demo-login', { method: 'POST' });
                const js = await resp.json();
                if (js.success) {
                    // Reload the page so the session cookie is correctly set and subsequent API calls include it
                    window.location.reload();
                    return;
                }
            } catch (e) { console.error('Demo login failed', e); }
            window.location.href = '/login.html';
        }

        async function loadPostedJobs() {
            try {
                const response = await fetch('/api/jobs');
                const allJobs = await response.json();
                
                // Filter jobs posted by current user
                postedJobs = allJobs.filter(job => job.recruiterId === userProfile.id);
                
                document.getElementById('totalJobs').textContent = postedJobs.length;
                
                const jobsContainer = document.getElementById('postedJobs');
                
                if (postedJobs.length === 0) {
                    jobsContainer.innerHTML = '<div class="empty-state">No jobs posted yet. Create your first job posting!</div>';
                    return;
                }

                const jobsHTML = postedJobs.map(job => `
                    <div class="job-item">
                        <h5>${job.title}</h5>
                        <p><strong>${job.company}</strong></p>
                        <p>${job.description.substring(0, 100)}${job.description.length > 100 ? '...' : ''}</p>
                        <p><small>Requirements: Apt ${job.requirements.aptitude}+, Tech ${job.requirements.technical}+, Comm ${job.requirements.communication}+</small></p>
                        <p><small>Posted: ${new Date(job.postedDate).toLocaleDateString()}</small></p>
                    </div>
                `).join('');

                jobsContainer.innerHTML = jobsHTML;
            } catch (error) {
                console.error('Error loading jobs:', error);
                document.getElementById('postedJobs').innerHTML = '<div class="empty-state">Error loading jobs</div>';
            }
        }

        async function loadAllStudents() {
            try {
                const response = await fetch('/api/students?aptitude=0&technical=0&communication=0');
                const students = await response.json();
                document.getElementById('totalStudents').textContent = students.length;
            } catch (error) {
                console.error('Error loading student count:', error);
            }
        }

        async function filterStudents() {
            const aptitude = document.getElementById('filterAptitude').value;
            const technical = document.getElementById('filterTechnical').value;
            const communication = document.getElementById('filterCommunication').value;

            try {
                document.getElementById('studentsList').innerHTML = '<div class="loading">Searching for candidates...</div>';
                
                const response = await fetch(`/api/students?aptitude=${aptitude}&technical=${technical}&communication=${communication}`);
                if (!response.ok) {
                    const text = await response.text();
                    const err = new Error('Server error while fetching students');
                    err.status = response.status;
                    err.message = text;
                    throw err;
                }
                const students = await response.json();
                
                document.getElementById('matchingCandidates').textContent = students.length;
                
                const studentsContainer = document.getElementById('studentsList');
                
                if (students.length === 0) {
                    studentsContainer.innerHTML = `
                        <div class="empty-state">
                            <p>No candidates found matching these requirements.</p>
                            <p>Try lowering the minimum scores to see more candidates.</p>
                        </div>
                    `;
                    return;
                }

                const studentsHTML = students.map(student => `
                    <div class="student-card">
                        <div class="student-header">
                            <div class="student-info">
                                <h4>${student.name}</h4>
                                <p>üìß ${student.email}</p>
                            </div>
                        </div>
                        <div class="scores">
                            <div class="score-badge ${getScoreClass(student.scores.aptitude)}">
                                üß† Aptitude: ${student.scores.aptitude}
                            </div>
                            <div class="score-badge ${getScoreClass(student.scores.technical)}">
                                ‚ö° Technical: ${student.scores.technical}
                            </div>
                            <div class="score-badge ${getScoreClass(student.scores.communication)}">
                                üí¨ Communication: ${student.scores.communication}
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <span style="font-size: 12px; color: #666;">
                                Total Score: ${student.scores.aptitude + student.scores.technical + student.scores.communication}/300
                            </span>
                        </div>
                    </div>
                `).join('');

                studentsContainer.innerHTML = studentsHTML;
            } catch (error) {
                console.error('Error filtering students:', error);
                let message = 'Error loading candidates. Please try again.';
                if (error && error.status) message += ` (${error.status})`;
                document.getElementById('studentsList').innerHTML = `<div class="empty-state"><p>${message}</p><pre style="text-align:left;color:#999;margin-top:10px;">${error && error.message ? error.message : ''}</pre></div>`;
            }
        }

        function getScoreClass(score) {
            if (score >= 80) return 'high';
            if (score >= 60) return 'medium';
            return 'low';
        }

        // Job form submission
        document.getElementById('jobForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                title: document.getElementById('jobTitle').value,
                company: document.getElementById('company').value,
                description: document.getElementById('description').value,
                requirements: {
                    aptitude: parseInt(document.getElementById('aptitudeReq').value),
                    technical: parseInt(document.getElementById('technicalReq').value),
                    communication: parseInt(document.getElementById('communicationReq').value)
                }
            };

            try {
                const response = await fetch('/api/jobs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (result.success) {
                    // Reset form
                    document.getElementById('jobForm').reset();
                    document.getElementById('aptitudeReq').value = '50';
                    document.getElementById('technicalReq').value = '50';
                    document.getElementById('communicationReq').value = '50';
                    
                    // Reload jobs
                    loadPostedJobs();
                    
                    alert('Job posted successfully! üéâ');
                } else {
                    alert('Failed to post job: ' + result.error);
                }
            } catch (error) {
                console.error('Error posting job:', error);
                alert('Failed to post job. Please try again.');
            }
        });

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/login.html';
            } catch (error) {
                window.location.href = '/login.html';
            }
        }

        // Initialize page
        window.addEventListener('load', () => {
            loadProfile();
        });

        // Add some nice animations
        window.addEventListener('load', () => {
            const cards = document.querySelectorAll('.card');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    card.style.transition = 'all 0.6s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 200);
            });
        });
    </script>
</body>
</html>